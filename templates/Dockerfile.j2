# This Dockerfile was generated from templates/Dockerfile.j2
{% set beat_home = '/usr/share/%s' % beat -%}
{% set binary_file = '%s/%s' % (beat_home, beat) -%}

FROM alpine:3.8 as builder
ENV GOPATH=/go \
    GOROOT=/usr/lib/go \
    PATH=$GOPATH/bin:/usr/local/go/bin:$PATH

RUN apk update && apk add git make go musl-dev bash libpcap-dev linux-headers

RUN go get github.com/magefile/mage \
    && go get github.com/mitchellh/gox

RUN git clone --single-branch -b v{{ elastic_version }} https://github.com/elastic/beats.git $GOPATH/src/github.com/elastic/beats \
    && cd $GOPATH/src/github.com/elastic/beats \
    && find . -iname 'Makefile' ! -path './winlogbeat/*' -exec sed -i 's/\(GOX_OS\|GOX_FLAGS\|GOX_OSARCH\)=/\1?=/g' {} \; \
    && sed -i 's/foreach var,filebeat winlogbeat metricbeat heartbeat auditbeat,/foreach var,filebeat metricbeat heartbeat auditbeat,/g' Makefile \
    && PATH=$GOPATH/bin:$PATH GOX_OS=`uname -s | tr '[:upper:]' '[:lower:]'` GOX_OSARCH=`uname -s | tr '[:upper:]' '[:lower:]'`/`uname -m` GOX_FLAGS='-arch=amd64' make crosscompile \
    && find ./ -iname "*-`uname -s | tr '[:upper:]' '[:lower:]'`-amd64" -exec cp {} $GOPATH/bin \;


# 
FROM alpine:3.8 as repos

RUN apk update && apk add curl

RUN curl -Lso - {{ url }} | \
      tar zxf - -C /tmp && \
    mv /tmp/{{ beat }}-{{ elastic_version }}-linux-x86_64 {{ beat_home }}

RUN rm {{ beat_home }}/{{ beat }}

# 
FROM alpine:3.8

RUN apk add --no-cache bash curl shadow libcap

COPY --from=repos {{ beat_home }}/ {{ beat_home }}/
COPY --from=builder /go/bin/{{ beat }}-linux-amd64 {{ beat_home }}/{{ beat }}

ENV ELASTIC_CONTAINER true
ENV PATH={{ beat_home }}:$PATH

COPY config {{ beat_home }}

# Add entrypoint wrapper script
ADD docker-entrypoint /usr/local/bin

# Provide a non-root user.
RUN groupadd --gid 1000 {{ beat }} && \
    useradd -M --uid 1000 --gid 1000 --home {{ beat_home }} {{ beat }}

WORKDIR {{ beat_home }}
RUN mkdir data logs && \
    chown -R root:{{ beat }} . && \
    find {{ beat_home }} -type d -exec chmod 0750 {} \; && \
    find {{ beat_home }} -type f -exec chmod 0640 {} \; && \
    chmod 0750 {{ binary_file }} && \
    {%- if beat == 'filebeat' or beat == 'metricbeat' -%}
    chmod 0770 modules.d && \
    {% endif -%}
    chmod 0770 data logs

{%- if beat == 'packetbeat' %}
RUN setcap cap_net_raw,cap_net_admin=eip {{ binary_file }}
{% endif %}
{%- if beat == 'heartbeat' %}
RUN setcap cap_net_raw=eip {{ binary_file }}
{% endif %}
{%- if beat == 'auditbeat' %}
USER root
{% else %}
USER 1000
{% endif %}

LABEL org.label-schema.schema-version="1.0" \
  org.label-schema.vendor="Elastic" \
  org.label-schema.name="{{ beat }}" \
  org.label-schema.version="{{ elastic_version }}" \
  org.label-schema.url="https://www.elastic.co/products/beats/{{ beat }}" \
  org.label-schema.vcs-url="https://github.com/elastic/beats-docker" \
{% if image_flavor == 'oss' -%}
  license="Apache-2.0"
{% else -%}
  license="Elastic License"
{% endif -%}

ENTRYPOINT ["/usr/local/bin/docker-entrypoint"]
CMD ["-e"]
